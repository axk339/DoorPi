{% extends "/dashboard/parts/base.html" %}
{% block content %}
			<div class="row">
				<div class="col-lg-12">
					<div class="panel panel-primary">
						<div class="panel-heading">
							<i class="fa fa-bar-chart-o"></i> Übersichten
						</div>
						<!-- /.panel-heading -->
						<div class="panel-body">
							<div class="modal fade" id="ModalFireEventResponse" tabindex="-1" role="dialog" aria-labelledby="ModalFireEventResponseLabel" aria-hidden="true" style="display: none;">
								<div class="modal-dialog">
									<div class="modal-content">
										<div class="modal-header">
											<button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
											<h4 class="modal-title" id="ModalFireEventResponseLabel">Modal title</h4>
										</div>
										<div class="modal-body" id="ModalFireEventResponseMessage">
										</div>
										<div class="modal-footer">
											<button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
										</div>
									</div>
									<!-- /.modal-content -->
								</div>
								<!-- /.modal-dialog -->
							</div>
							<ul class="nav nav-tabs">
								<li class="active"><a href="#RegEvents" data-toggle="tab" aria-expanded="true">Events mit Aktion</a></li>
								<li class=""><a href="#RegAction" data-toggle="tab" aria-expanded="false">Registrierte Aktionen</a></li>
								<li class=""><a href="#SourceEvent" data-toggle="tab" aria-expanded="false">Verfügbare Events</a></li>
							</ul>
							<div class="tab-content">
								<div class="tab-pane fade active in" id="RegEvents">
									<div class="dataTable_wrapper well">
										<table class="display table table-bordered table-hover table-striped TableIsRefreshable" id="idRegEvents"></table>
									</div>
								</div>
								<div class="tab-pane fade" id="RegAction">
									<div class="dataTable_wrapper well">
										<table class="display table table-bordered table-hover table-striped TableIsRefreshable" id="idRegActions"></table>
									</div>
								</div>
								<div class="tab-pane fade" id="SourceEvent">
									<div class="dataTable_wrapper well">
										<table class="display table table-bordered table-hover table-striped TableIsRefreshable" id="idSourceEvents"></table>
									</div>
								</div>
							</div>
						</div>
						<!-- /.panel-body -->
						<div class="panel-footer">
						</div>
						<!-- /.panel-footer -->
					</div>
					<!-- /.panel -->
				</div>
			</div>
			<script>
				// source: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/encodeURIComponent#Examples
				function encodeRFC5987ValueChars(str) {
					return encodeURIComponent(str)
						// Note that although RFC3986 reserves "!", RFC5987 does not,
						// so we do not need to escape it
						.replace(/['()]/g, escape) // i.e., %27 %28 %29
						.replace(/\*/g, '%2A')
						// The following are not required for percent-encoding per RFC5987,
						// so we can allow for a little better readability over the wire: |`^
						.replace(/%(?:7C|60|5E)/g, unescape);
				}
				function GetFireEventUrl(sSourceName, sEventName) {
					var sFireEventUrl = "/control/trigger_event?";
					sFireEventUrl += "event_name="+encodeRFC5987ValueChars(sEventName)+"&";
					sFireEventUrl += "event_source="+encodeRFC5987ValueChars(sSourceName);
					return sFireEventUrl;
				}
				function FireEventNow (sSourceName, sEventName) {
					var sFireEventUrl = GetFireEventUrl(sSourceName, sEventName);

					$.getJSON(sFireEventUrl, function(result){
						if (result.success == true) {
							$("#ModalFireEventResponseLabel").html("Fire event success");
						} else {
							$("#ModalFireEventResponseLabel").html("Fire event failed");
						}
						$("#ModalFireEventResponseMessage").html(String(result.message));
						return false;
					});
					return false;
				}

				$(document).ready(function() {
					$('#idRegEvents').dataTable({
						"ajax": {
							"url": "/status?module=event_handler&name=actions&output=json",
							"type": "GET",
							"dataSrc": function (aSourceObject) {
								oConfigObject = aSourceObject.event_handler.actions;
								var aReturnArray = new Array();

								$.each(oConfigObject, function(sEventName, aActionList) {
										aReturnArray.push({
											event_name: sEventName,
											action_count: aActionList.length
										});
								});
								return aReturnArray;
							}
						},
						"lengthMenu": [[10, 25, 50, -1], [10, 25, 50, "All"]],
						"iDisplayLength": -1,
						"colReorder": true,
						"columns": [
							{"data": "event_name", "title": "Event"},
							{"data": "action_count", "title": "Anzahl Aktionen"}
						]
					});
					$('#idRegActions').dataTable({
						"ajax": {
							"url": "/status?module=event_handler&name=actions&output=json",
							"type": "GET",
							"dataSrc": function (aSourceObject) {
								oConfigObject = aSourceObject.event_handler.actions;
								var aReturnArray = new Array();

								$.each(oConfigObject, function(sEventName, aActionList) {
									$.each(aActionList, function(i, oActionObject) {
										aReturnArray.push({
											event_name: sEventName,
											order_id: i+1,
											action_name: $('<div/>').text(String(oActionObject)).html() // thx to http://stackoverflow.com/a/10825766
										});
									});
								});
								return aReturnArray;
							}
						},
						"lengthMenu": [[10, 25, 50, -1], [10, 25, 50, "All"]],
						"iDisplayLength": -1,
						"colReorder": true,
						"columns": [
							{"data": "event_name", "title": "Eventname"},
							{"data": "order_id", "title": "Reihenfolge"},
							{"data": "action_name", "title": "Action"}
						]
					});
					$('#idSourceEvents').dataTable({
						"ajax": {
							"url": "/status?module=event_handler&name=events_by_source&output=json",
							"type": "GET",
							"dataSrc": function(aSourceObject) {
								oConfigObject = aSourceObject.event_handler.events_by_source
								var aReturnArray = new Array();

								$.each(oConfigObject, function(sSourceName, aEventList) {
									$.each(aEventList, function(i, oEventObject) {
										var sFireEventUrl = GetFireEventUrl(sSourceName, String(oEventObject));
										/*
										var oFireButton = $('<button>', {
											type: "button",
											'class': "btn btn-warning",
											'data-toggle': "modal",
											'data-target': "#ModalFireEventResponse",
											text: String(oEventObject)
										});
										var oFireButtonLink = $('<a>',{
											//text: oFireButton[0].outerHTML,
											title: 'fire event '+String(oEventObject)+'in the name of '+sSourceName,
											href: sFireEventUrl,
											click: function() {
												BlahFunc( options.rowId );
												return false;
											}
										}).bind('click',function(){BlahFunc( options.rowId ); return false;}).append(oFireButton);
										*/
										var sFireButton = '<a href="'+sFireEventUrl+'">';
										sFireButton += '<button type="button" class="btn btn-warning" data-toggle="modal" data-target="#ModalFireEventResponse"';
										sFireButton += 'onclick="FireEventNow(\''+sSourceName+'\', \''+String(oEventObject)+'\'); return false;">';
										sFireButton += String(oEventObject);
										sFireButton += '</button>'+'</a>';

										aReturnArray.push({
											source_name: sSourceName,
											fire_button: sFireButton,//oFireButtonLink[0].outerHTML,
											event_name: $('<div/>').text(String(oEventObject)).html() // thx to http://stackoverflow.com/a/10825766
										});
									});
								});
								return aReturnArray;
							}
						},
						"lengthMenu": [[10, 25, 50, -1], [10, 25, 50, "All"]],
						"iDisplayLength": -1,
						"aButtons": ["refresh"],
						"columns": [
							{"data": "source_name", "title": "Quelle"},
							{"data": "fire_button", "title": "Event"}
						]
					});
					$('<button class="refreshButton">Refresh</button>').appendTo('div.dataTables_filter');
					$('.refreshButton').click(function() {
						$('.TableIsRefreshable').DataTable().ajax.reload();
					});
				});
			</script>
{% endblock %}
{# vim:set ts=4 noet sw=0: #}
